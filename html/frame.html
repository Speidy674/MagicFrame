<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>MagicFrame - Frame</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
        integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"
        integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS"
        crossorigin="anonymous"></script>
    <script>

        var frameId = window.location.hash.substr(1);
        var oldType = "";
        var baseUrl = "/data/";

        var socket = io({
            extraHeaders: {
                "frameId": frameId,
                "width": window.screen.availWidth,
                "height": window.screen.availHeight
            }
        });
        var app = {}

        $(document).ready(function () {
            app = {
                oldVideo: document.getElementById("oldVideo"),
                video: document.getElementById("video"),
                oldImg: document.getElementById("oldImg"),
                img: document.getElementById("img")
            }
            setTimeout(init, 500);
        });

        function init() {
            showApp();
            console.log("Init Frame");
            socket.emit('initFrame', frameId);
        }

        function showApp() {
            $('#app').css('display', 'block');
            $('#loader').css('display', 'none');
        }

        function showError(color, text) {
            $('#app').css('display', 'none');
            $('#loader').css('display', 'flex');
            $("#loader").css('--loader-color', color);
            $("#loader").css('--loader-text', text);
        }

        socket.on("connect_error", (err) => {
            resetFrame();
            showError('red', "'Magic Frame\\A\\A Connection Error'")
            console.log("connect_error: " + err);
        });

        socket.on("disconnect", (err) => {
            resetFrame();
            showError('red', "'Magic Frame\\A\\A Disconnected'")
            console.log("disconnect: " + err);
        });

        socket.io.on("reconnect", () => {
            setTimeout(init, 500);
        });

        socket.on("change", (...args) => {
            var json = JSON.parse(args);
            console.log("change to " + json.type + ": " + baseUrl + json.file);

            if (json.type == "img") {
                loadPic(baseUrl + json.file + "");
            } else if (json.type == "vid") {
                loadVid(baseUrl + json.file + "");
            } else {
                console.error("type " + json.type + " is not supported");
            }
        });

        function copyFrame() {

            app.oldImg.src = img.src;

            if (app.oldVideo.src != "") {
                app.oldVideo.src = app.video.src;
                app.oldVideo.currentTime = app.video.currentTime;
                app.oldVideo.play();
            }

            if (oldType == "img") {
                app.oldImg.style.opacity = 1;
                app.oldImg.style.display = 'block';
                app.img.style.opacity = 0;
                app.img.style.display = 'none';
            }

            if (oldType == "video") {
                app.oldVideo.style.opacity = 1;
                app.oldVideo.style.display = 'block';
                app.video.style.opacity = 0;
                app.video.style.display = 'none';
            }
        }

        function blendFrame(type) {

            var frame = document.getElementById(type);

            oldFrameOP = 1;
            newTypeOP = 0.1;

            var oldFrame = setInterval(function () {
                if (oldFrameOP <= 0.1) {
                    clearInterval(oldFrame);
                    app.oldImg.style.display = 'none';
                    app.oldImg.src = "";
                    app.oldVideo.style.display = 'none';
                    app.oldVideo.src = "";
                }
                if (oldType == "img") {
                    app.oldImg.style.opacity = oldFrameOP;
                    app.oldImg.style.filter = 'alpha(opacity=' + oldFrameOP * 100 + ")";
                }

                if (oldType == "video") {
                    app.oldVideo.style.opacity = oldFrameOP;
                    app.oldVideo.style.filter = 'alpha(opacity=' + oldFrameOP * 100 + ")";
                }

                oldFrameOP -= oldFrameOP * 0.1;
            }, 50);

            var frameTimer = setInterval(function () {
                frame.style.display = 'block';

                if (newTypeOP >= 1) {
                    clearInterval(frameTimer);
                }

                frame.style.opacity = newTypeOP;
                frame.style.filter = 'alpha(opacity=' + newTypeOP * 100 + ")";
                newTypeOP += newTypeOP * 0.1;
                oldType = type;

            }, 50);
        }

        function loadVid(url) {
            copyFrame();

            app.video.src = url;
            app.video.play();

            app.img.src = "";

            setTimeout(function () {
                blendFrame("video");
            }, 100);
        }

        function loadPic(url) {
            copyFrame();

            app.img.src = url;

            app.video.src = "";

            setTimeout(function () {
                blendFrame("img");
            }, 100);
        }

        function resetFrame() {
            app.video.src = "";
            app.img.src = "";
            app.oldVideo.src = "";
            app.oldImg.src = "";

            oldType = "";


            $("#loader").css('--loader-color', 'white');
            $("#loader").css('--loader-text', "'Magic Frame\\A\\A #VERSION#'");
        }
    </script>
    <style>
        #app {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: black;
        }

        #img,
        #oldImg {
            width: 100%;
            height: 100%;
            position: absolute;
            object-fit: contain;
        }

        #video,
        #oldVideo {
            width: 100%;
            height: 100%;
            position: absolute;
            object-fit: contain;
        }
    </style>
</head>

<body>
    <div id="loader" style="--loader-color: white; --loader-text:'Magic Frame\A\A #VERSION#'">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                background: #121212;
            }

            #loader {
                width: 250px;
                height: 250px;
                box-shadow: 16px 14px 20px #0000008c;
                border-radius: 25px;
                position: relative;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
                /*-webkit-mask-size: cover;*/
                /*-webkit-mask-position: center;*/
                /*-webkit-mask-image: url(imgs/logo-test.png);*/
                /*mask-size: cover;*/
                /*mask-position: center;*/
                /*mask-image: url(imgs/logo-test.png);*/
            }

            #loader:before {
                content: "";
                background-image: conic-gradient(var(--loader-color) 20deg,
                        transparent 120deg);
                width: 150%;
                height: 150%;
                position: absolute;
                animation: rotate 2s linear infinite;
            }

            #loader::after {
                content: var(--loader-text);
                width: 240px;
                height: 240px;
                background: #101010;
                position: absolute;
                border-radius: 25px;
                display: flex;
                justify-content: center;
                align-items: center;
                color: var(--loader-color);
                font-size: larger;
                letter-spacing: 5px;
                box-shadow: inset 20px 20px 20px #0000008c;
                white-space: pre;
                text-align: center;
                /*-webkit-mask-size: cover;*/
                /*-webkit-mask-position: center;*/
                /*-webkit-mask-image: url(imgs/logo-test.png);*/
                /*mask-size: cover;*/
                /*mask-position: center;*/
                /*mask-image: url(imgs/logo-test.png);*/
            }

            @keyframes rotate {
                0% {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(-360deg);
                }
            }
        </style>
    </div>

    <div id="app" style="display:none">
        <img src="" id="oldImg" style="display:none"></img>
        <video src="" id="oldVideo" muted loop></video>
        <img src="" id="img" style="display:none"></img>
        <video src="" id="video" muted loop></video>
    </div>

</body>

</html>